---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "bWCZgfbLCBMQSJSBo1a4rhcsrEOy7bYBgCyq+beTnEqlvIjrcYYQakP\
      fub5CrSKJ7OVzHWEPUkdvelEd/Py4wsb40dXVd4vn1QSXM0sdjnjg8nxmd9BJKUX\
      4/g+kyhrZ4UobRP/IuxeqDZHqrDmRdodcGSx7iN2bNPcd5f4MoFDEnO3v4BT+ZT1\
      s4SCxe8N3WeJT2/LeVjIqDPoWYjdzpAB93QMdCR22KHib09FyskCUH9CZ0JxUfp0\
      dftzZmGJcu+vbsLidyg7ko0RnzB0J/B3xHxOLd+7l2y1wIVeGpdWeui6JNCssVti\
      etcpGrCVQENVB9CqdSzl0jJpppcKLv6Qu8QRa6owl7jnUUNdg1fWGsK0klBr8Bsu\
      avxG8GNaOQqp4mGNZBqNENHO33GZ/LM3lvUkyW8B4K0sBJV+QNAzJDX8ahGR3U9g\
      moVC2KAc6Fy6T9YHz1iEHzEZ4w9JvplKeEwb9OTuhq72ByHUhiCaMEIBYuBuKYYQ\
      VgfxXriYS6pelOPNlyQZiAwIOK7BgJJGqyKmdSohbPN4oFaKAAl/1HlwpIlfMOGb\
      XrLh5Z4HIzQDUgbt6snGVRwmPhdEwP56VijH1o09fIISG0FmcAvjsGTL7rt4CwCv\
      0ecOnW+j5x28UocAvVJf/jHr9FYqZn5PUMcYFO3TjioqBMfbg260="
    - AWS_DEFAULT_REGION="us-east-1"
    # AWS_SECRET_ACCESS_KEY
    - secure: "VVUddyXcKxm0BLRDLxj0PS3JPPoasSMG1gyJ01f8kyhSRnBXK403lzG\
      FaxeW7n/4C68UVmj/HPeTQSjT3GpwhFKc3HQDuhhLO5kzQcbdwdFETDn2WUL8ZTJ\
      g/8H0gqAffvWBlRiLItkmIftGQxvU8gHDHFy0GxoK9vQPNq1vwtcfmulyro+tZEs\
      uXwZAxnpeKyaPdCDYPBHkMZedQMe41JAOG+GmjnUK3pllcsnhVFD77n1kZcFVoKE\
      7JjbrSqntmYoLkcnS/iN1ept2e1TU8MovSVPKCkGMZwo6A2ktFn4ac96boKKmjXV\
      F6Ky030VhzBRxZr5x1kBjdyXjkfdctYNVz42uAFFSQ4wtHnWBSsWatRITASw0RlS\
      oDgv6JCwN4zJjq75bbXrRQGqyEvvKcYwaZedZpfzV04r1wILN7W3WfJRHG5MRGuY\
      V2EBRasuXR5uAKd2V55GDh8o7KLbcUJMc8g0NJ6z4ZTxRk4e2MwFybAVaA828LUA\
      K22tjg9cTHRLHgz9EED3W+0Be1ULNXi1CW5+a50/0/J6uiKv6qvxoABomDZtHlmF\
      weA/0H9KIyF/AcbJCTHS3vMWde+FKaEZhj8N/MqQLNxMLzsBDBaA1AT/zVEbQNV9\
      mGar+wU49HKeA6ObQjBfLR/q4OMIFUtw3BzH22sIPj31TvrIZtQQ="
    - CURL_CACHE_DIR="$HOME/.cache/curl"
    # GITHUB_ACCESS_TOKEN
    - secure: "CMVLqC2AYZ78mEn8w1GWv3p7Ci5lProngCei/Fzin0KCYrsV+DEBQCm\
    6nKvv/wmEKIy79BpdF2GNwz23uiJXE8VF9A3WBM82coF5KfCO1CporqsQ25cLYSwCF\
    j8AxsT4n5JXHtXVsuNk0QETspZcDBjfOtdIS0p/YYArkpBS69NFJg4d7STcCPnIgRX\
    /06ksN9WRbliiiQ70gdkZpZE5ceqMH3mRiUFFKU9aTF2DnDDaYLVXbHqjtYL621HYa\
    /XywUQ6YZwFEbz8n4XwGqARILJOfz0FPJcKCOAnAnbGwY3ejef15lEMDZQuPzb7kPy\
    hhykpbNKY028781GyQxJrPMYx1AYOlAeP/vkFUGQvMXbOuEF6WLLv3CHsx1MX30EW3\
    bZL5FBgxwvg5v/PgFQNdh8Ma+e02D2p+AHWUCf3VhwHqdKovk3ebDRlF2geJYl8KP7\
    HiqSnKlITsvRxh+tZdvBR7rNv6+PjsjfR00hMI4KY45Z6eoLXcXz9icwT76Q1+Adnz\
    eMACE+Yb3HLdg4mfo6Ni3Fkdz+8ODw750crSsR1/TAGeFL8F+qp+1eqScMbz+vxoyv\
    yKDN3LCV3Sj6nmiE4d3UmjP/YKkQxD9cqCzBFMuUtJKgNajpbuy0WKdtkConb2wxSa\
    3bX4KmUdPpv1mLNg5ugcp+8PWT1/Bb0U2A="
    - PACKER_BUILD_REGION="us-east-2"
    - PACKER_DEPLOY_REGION_KMS_MAP="us-east-1:alias/cool/ebs,
                                    us-east-2:alias/cool/ebs,
                                    us-west-1:alias/cool/ebs,
                                    us-west-2:alias/cool/ebs"
    - PACKER_VERSION="1.4.4"
    - PACKER_ZIP="packer_${PACKER_VERSION}_linux_amd64.zip"
    - TERRAFORM_VERSION="0.12.10"
    - TERRAFORM_ZIP="terraform_${TERRAFORM_VERSION}_linux_amd64.zip"


# Cache pip packages, pre-commit plugins, and some curl downloads to
# speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit
    - $CURL_CACHE_DIR

before_install:
  # Make a cache directory for curl downloads
  - mkdir -p $CURL_CACHE_DIR
  # Install terraform
  - curl --output "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}" --location
      "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ZIP}"
  - sudo unzip -d /opt/terraform "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  # Install packer
  - curl --output "${CURL_CACHE_DIR}/${PACKER_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${PACKER_ZIP}" --location
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/${PACKER_ZIP}"
  - sudo unzip -o -d /usr/local/bin "${CURL_CACHE_DIR}/${PACKER_ZIP}"

install:
  - pip install --upgrade --requirement requirements-test.txt
  - export PACKER_IMAGE_VERSION=$(./bump_version.sh show)
  # Install roles
  - ansible-galaxy install --force --role-file src/requirements.yml

script:
  - pre-commit run --all-files
  - ./patch_packer_config.py query-github src/packer.json
  - packer validate src/packer.json
  - pytest

before_deploy:
  - pip install travis-wait-improved

deploy:
  # create an image when tagged
  - provider: script
    # preserve patch to packer configuration by skipping cleanup
    skip_cleanup: true
    script: travis-wait-improved --timeout=30m packer build --timestamp-ui
      src/packer.json
    on:
      tags: true
